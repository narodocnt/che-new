<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Відділ народної творчості</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --soft-blue: #a2b9bc;
            --soft-bg: #f4f7f6;
            --white: #ffffff;
            --active-green: #a3b18a;
        }
        body { font-family: 'Segoe UI', sans-serif; background: var(--soft-bg); margin: 0; text-align: center; color: #505e63; }
        header { background: var(--white); padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.02); }
        .auth-btn { font-weight: 600; color: var(--soft-blue); cursor: pointer; padding: 7px 20px; border: 2px solid var(--soft-blue); border-radius: 20px; transition: 0.3s; }
        .container { max-width: 600px; margin: 80px auto; padding: 40px; background: white; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.03); }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); backdrop-filter: blur(5px); z-index: 10000; justify-content: center; align-items: center; }
        .modal-box { background: white; padding: 40px; border-radius: 20px; max-width: 350px; position: relative; }
        .btn { display: inline-block; padding: 12px 30px; border-radius: 30px; text-decoration: none; font-weight: 600; cursor: pointer; border: none; margin: 10px; transition: 0.3s; }
        .btn-blue { background: var(--soft-blue); color: white; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        #loading-screen { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: white; z-index: 20000; justify-content: center; align-items: center; flex-direction: column; }
    </style>
</head>
<body>

<div id="loading-screen">
    <i class="fas fa-spinner fa-spin fa-3x" style="color: var(--soft-blue);"></i>
    <p style="margin-top: 20px; font-weight: 600;">Відкриваємо форму заявки...</p>
</div>

<header>
    <h1 style="color: var(--soft-blue); font-size: 1.2rem; margin:0;">ОЦНТ Черкаси</h1>
    <div class="auth-btn" id="loginBtn" onclick="handleAuthAction()">Login</div>
</header>

<div class="container">
    <h2>Вітаємо!</h2>
    <p>Для подачі заявки натисніть кнопку нижче.</p>
    <button onclick="checkAccessAndRedirect()" class="btn btn-blue" style="font-size: 1.1rem;">ПОДАТИ ЗАЯВКУ</button>
</div>

<div id="authModal" class="modal-overlay">
    <div class="modal-box" id="modalBox">
        <h3>Авторизація</h3>
        <p>Форма доступна тільки для авторизованих користувачів.</p>
        <button class="btn btn-blue" onclick="login()">УВІЙТИ ЧЕРЕЗ GOOGLE</button>
        <p style="font-size: 12px; color: #aaa; cursor: pointer; margin-top: 15px;" onclick="closeModal()">Скасувати</p>
    </div>
</div>

<script>
const GOOGLE_AUTH_URL = "https://accounts.google.com/o/oauth2/v2/auth?client_id=734541752522-bqp7ljgjq27k8psn3pv6g3c3rcp16fhi.apps.googleusercontent.com&redirect_uri=https://n8n.narodocnt.online/webhook/google-signup&response_type=code&scope=openid%20email%20profile&prompt=consent";
const N8N_FORM_URL = "https://n8n.narodocnt.online/webhook/2e38b09c-9ea5-4123-bdf0-b26dfdf7432c/n8n-form";

// 1. ПРИМУСОВА ПЕРЕВІРКА ПРИ ЗАВАНТАЖЕННІ (виконується миттєво)
(function quickCheck() {
    const urlParams = new URLSearchParams(window.location.search);
    const name = urlParams.get('name');

    if (name) {
        // Ховаємо контент і показуємо лоадер
        document.addEventListener("DOMContentLoaded", () => {
            document.getElementById('loading-screen').style.display = 'flex';
        });

        // Зберігаємо ім'я
        localStorage.setItem('userName', decodeURIComponent(name));
        
        // Очищуємо URL
        const cleanUrl = window.location.protocol + "//" + window.location.host + window.location.pathname;
        window.history.replaceState({}, document.title, cleanUrl);

        // Прямий редірект на форму
        window.location.replace(N8N_FORM_URL);
    }
})();

// 2. ОНОВЛЕННЯ ІНТЕРФЕЙСУ
window.onload = function() {
    const savedName = localStorage.getItem('userName');
    const loginBtn = document.getElementById('loginBtn');
    
    if (savedName && loginBtn) {
        loginBtn.innerText = savedName;
        loginBtn.style.background = "var(--active-green)";
        loginBtn.style.color = "white";
        loginBtn.style.borderColor = "var(--active-green)";
    }
};

// 3. ЗАКРИТТЯ КЛІКОМ МИМО МОДАЛКИ
document.getElementById('authModal').addEventListener('mousedown', function(e) {
    if (e.target.id === 'authModal') closeModal();
});

// 4. ЛОГІКА КНОПОК
function checkAccessAndRedirect() {
    if (localStorage.getItem('userName')) {
        window.location.href = N8N_FORM_URL;
    } else {
        document.getElementById('authModal').style.display = 'flex';
    }
}

function handleAuthAction() {
    if (localStorage.getItem('userName')) {
        if (confirm("Вийти з системи?")) {
            localStorage.removeItem('userName');
            location.reload();
        }
    } else {
        login();
    }
}

function login() { window.location.href = GOOGLE_AUTH_URL; }
function closeModal() { document.getElementById('authModal').style.display = 'none'; }
</script>

</body>
</html>
