<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö—É–ª—å—Ç—É—Ä–Ω–∞ –º–∞–ø–∞ –ß–µ—Ä–∫–∞—â–∏–Ω–∏</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #map { height: 100vh; width: 100%; background: #f4f4f4; }

        /* –°—Ç–∏–ª—å –∫–Ω–æ–ø–æ–∫ –∫–µ—Ä—É–≤–∞–Ω–Ω—è */
        .map-controls {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            background: white;
            padding: 6px;
            border-radius: 35px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        .map-btn {
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            font-size: 14px;
            transition: 0.3s;
            background: none;
            color: #333;
        }

        .map-btn.active {
            background: #8b0000;
            color: white;
        }

        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: white;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            text-decoration: none;
            font-size: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        /* –°—Ç–∏–ª—å –≤—ñ–∫–æ–Ω—Ü—è (Popup) */
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            padding: 5px;
        }
        .popup-title {
            color: #8b0000;
            font-size: 16px;
            margin-bottom: 5px;
            display: block;
        }
    </style>
</head>
<body>

    <a href="index.html" class="back-btn" title="–ù–∞ –≥–æ–ª–æ–≤–Ω—É">üè†</a>

    <div class="map-controls">
        <button id="btn-col" class="map-btn active" onclick="showLayer('collectives')">üé≠ –ö–æ–ª–µ–∫—Ç–∏–≤–∏</button>
        <button id="btn-bat" class="map-btn" onclick="showLayer('battle')">üèÜ –ë–∏—Ç–≤–∞ –≥—Ä–æ–º–∞–¥</button>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script src="collectives.js"></script>
    <script src="map-data.js"></script>

    <script>
        // 1. –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è –∫–∞—Ä—Ç–∏ (–¶–µ–Ω—Ç—Ä - –ß–µ—Ä–∫–∞—â–∏–Ω–∞)
        var map = L.map('map').setView([49.444, 31.5], 8);

        // –°–≤—ñ—Ç–ª–∞ –ø—ñ–¥–∫–ª–∞–¥–∫–∞ –∫–∞—Ä—Ç–∏
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; OpenStreetMap'
        }).addTo(map);

        // 2. –°—Ç–≤–æ—Ä–µ–Ω–Ω—è —à–∞—Ä—ñ–≤
        var collectivesLayer = L.layerGroup().addTo(map);
        var battleLayer = L.geoJson(null, {
            style: battleStyle,
            onEachFeature: onEachHromada
        });

        // 3. –î–æ–¥–∞–≤–∞–Ω–Ω—è –º–∞—Ä–∫–µ—Ä—ñ–≤ –∑ map-data.js
        if (typeof mapCollectives !== 'undefined') {
            mapCollectives.forEach(function(item) {
                var marker = L.marker([item.lat, item.lng]);
                marker.bindPopup(`
                    <strong class="popup-title">${item.city}</strong>
                    <b>${item.count}</b><br>
                    <hr>
                    <div style="font-size:12px; line-height:1.4;">${item.names}</div>
                `);
                marker.addTo(collectivesLayer);
            });
        }

        // 4. –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –º–µ–∂ –≥—Ä–æ–º–∞–¥ (GeoJSON) —Ç–∞ –ª–æ–≥—ñ–∫–∞ "–ë–∏—Ç–≤–∏"
        fetch('https://raw.githubusercontent.com/uablock/ukraine-geojson/master/cherkasy_region_hromadas.json')
            .then(res => res.json())
            .then(data => {
                battleLayer.addData(data);
            });

        function battleStyle(feature) {
            // –¢—É—Ç –±—É–¥–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ –≤–∞—à n8n. –ü–æ–∫–∏ —â–æ –≤–∏–ø–∞–¥–∫–æ–≤—ñ –∫–æ–ª—å–æ—Ä–∏ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü—ñ—ó
            var randomScore = Math.floor(Math.random() * 1000);
            return {
                fillColor: randomScore > 700 ? '#8b0000' : 
                           randomScore > 400 ? '#e65a5a' : '#ffcccc',
                weight: 1.5,
                opacity: 1,
                color: 'white',
                fillOpacity: 0.7
            };
        }

        function onEachHromada(feature, layer) {
            layer.bindPopup("<b>–ì—Ä–æ–º–∞–¥–∞:</b> " + feature.properties.name + "<br>–†–µ–π—Ç–∏–Ω–≥: –≤ –ø—Ä–æ—Ü–µ—Å—ñ...");
        }

        // 5. –§—É–Ω–∫—Ü—ñ—è –ø–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è —Ä–µ–∂–∏–º—ñ–≤
        function showLayer(type) {
            var btnCol = document.getElementById('btn-col');
            var btnBat = document.getElementById('btn-bat');

            if (type === 'collectives') {
                btnCol.classList.add('active');
                btnBat.classList.remove('active');
                map.addLayer(collectivesLayer);
                map.removeLayer(battleLayer);
            } else {
                btnBat.classList.add('active');
                btnCol.classList.remove('active');
                map.addLayer(battleLayer);
                map.removeLayer(collectivesLayer);
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –º–∞—Å—à—Ç–∞–±—É—î–º–æ –∫–∞—Ä—Ç—É –ø—ñ–¥ –º–µ–∂—ñ –æ–±–ª–∞—Å—Ç—ñ
                map.fitBounds(battleLayer.getBounds());
            }
        }
    </script>
</body>
</html>
